<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Leilão</title>
    <link
      rel="stylesheet"
      href="assets/vendors/iconfonts/mdi/css/materialdesignicons.min.css"
    />
    <link rel="stylesheet" href="assets/vendors/css/vendor.bundle.base.css" />
    <link rel="stylesheet" href="assets/vendors/css/vendor.bundle.addons.css" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="shortcut icon" href="assets/images/favicon.png" />
  </head>

  <body>
    <div class="container-scroller">
      <nav class="navbar horizontal-layout col-lg-12 col-12 p-0">
        <div class="container d-flex flex-row">
          <div class="text-center navbar-brand-wrapper d-flex align-items-top">
            <a
              class="navbar-brand brand-logo"
              href="index.html"
              style="color: #714df8;"
              >Leilão</a
            >
            <a class="navbar-brand brand-logo-mini" href="index.html">Leilão</a>
          </div>
        </div>
        <div class="nav-bottom">
          <div class="container">
            <ul class="nav page-navigation">
              <li class="nav-item">
                <a href="index.html" class="nav-link"
                  ><i class="link-icon mdi mdi-television"></i
                  ><span class="menu-title">LEILÃO</span></a
                >
              </li>
              <li class="nav-item">
                <a href="pages/add.html" class="nav-link"
                  ><i class="link-icon mdi mdi-apple-safari"></i
                  ><span class="menu-title">ADICIONAR ITEM</span></a
                >
              </li>
            </ul>
          </div>
        </div>
      </nav>
      <div class="container-fluid page-body-wrapper">
        <div class="main-panel">
          <div class="content-wrapper">
            <div class="row">
              <div class="col-12 grid-margin">
                <div class="card">
                  <div class="card-body">
                    <h4 class="card-title">Itens</h4>
                    <p class="card-description">
                      Itens disponíveis para leilão.
                    </p>
                    <div class="table-responsive">
                      <table id="itens" class="table table-hover">
                        <thead>
                          <tr>
                            <th>Item</th>
                            <th>Descrição</th>
                            <th>Lance atual</th>
                            <th>Tempo restante de leilão</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td>Jacob</td>
                            <td>Photoshop</td>
                            <td class="text-danger">
                              28.76% <i class="mdi mdi-arrow-down"></i>
                            </td>
                            <td>
                              <label class="badge badge-danger">Pending</label>
                            </td>
                          </tr>
                          <tr>
                            <td>Messsy</td>
                            <td>Flash</td>
                            <td class="text-danger">
                              21.06% <i class="mdi mdi-arrow-down"></i>
                            </td>
                            <td>
                              <label class="badge badge-warning"
                                >In progress</label
                              >
                            </td>
                          </tr>
                          <tr>
                            <td>John</td>
                            <td>Premier</td>
                            <td class="text-danger">
                              35.00% <i class="mdi mdi-arrow-down"></i>
                            </td>
                            <td>
                              <label class="badge badge-info">Fixed</label>
                            </td>
                          </tr>
                          <tr>
                            <td>Peter</td>
                            <td>After effects</td>
                            <td class="text-success">
                              82.00% <i class="mdi mdi-arrow-up"></i>
                            </td>
                            <td>
                              <label class="badge badge-success"
                                >Completed</label
                              >
                            </td>
                          </tr>
                          <tr>
                            <td>Dave</td>
                            <td>53275535</td>
                            <td class="text-success">
                              98.05% <i class="mdi mdi-arrow-up"></i>
                            </td>
                            <td>
                              <label class="badge badge-warning"
                                >In progress</label
                              >
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-12 grid-margin">
                <div class="card">
                  <div class="card-body">
                    <h4 class="card-title">Dar Lance</h4>
                    <p class="card-description">
                      Basic form layout
                    </p>
                    <form class="forms-sample">
                      <div class="form-group">
                        <label for="exampleInput1">Número do item</label>
                        <input
                          type="text"
                          class="form-control"
                          id="exampleInput1"
                          placeholder="#000"
                        />
                      </div>
                      <div class="form-group">
                        <label for="exampleInput2">Valor</label>
                        <input
                          type="text"
                          class="form-control"
                          id="exampleInput2"
                          placeholder="R$"
                        />
                      </div>
                      <button type="submit" class="btn btn-success mr-2">
                        Enviar lance
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <footer class="footer">
            <div class="container-fluid clearfix">
              <span
                class="text-muted d-block text-center text-sm-left d-sm-inline-block"
                >Copyright © 2019 <a href="#" target="_blank">Leilão</a>. Todos
                os direitos reservados.</span
              >
              <span
                class="float-none float-sm-right d-block mt-1 mt-sm-0 text-center"
                >Renato</span
              >
            </div>
          </footer>
        </div>
      </div>
    </div>
    <script src="assets/vendors/js/vendor.bundle.base.js"></script>
    <script src="assets/vendors/js/vendor.bundle.addons.js"></script>
    <script src="assets/js/template.js"></script>
    <script src="assets/js/dashboard.js"></script>
    <script language="javascript" type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script language="javascript" type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/web3-min-js@1.0.0/web3.min.js"></script>
    <script language="javascript" type="text/javascript" src="js/abi.js"></script>

    <script>
          var leilao;
          var userAccount;
          var actualAccount;

          function startApp(){
              var contractAddress = '0x20f0FD75DC62967fB1D0E3e6cf0C9c21E79A1C00';

              var ok = document.getElementById("itens");

              leilao = new web3.eth.Contract(abi, contractAddress);

              var accountInterval = setInterval(function() {

                  web3.eth.getAccounts().then(function (result) {
                      actualAccount = result[0];
                  })

                  // Check if account has changed
                  if (actualAccount !== userAccount) {
                      userAccount = actualAccount;
                      // Call some function to update the UI with the new account
                      // $("#contractAddress").text("Your Account: " + userAccount);
                      atualizarDados();
                  }
              }, 100);
          }

          function dar_lance(id){
              var id = document.getElementById("item_id").value;
              var lance_atual = document.getElementById("item_lance_atual").value;
              var valor = 1000000000000000000*lance_atual;
              leilao.methods.dar_lance(id).send({ from: userAccount, value: valor });
              return false;
          }

          function mostrar_itens_disponiveis() {
              var ids = document.getElementById("item_id").value;
              $("#itens").empty();
              for (id of ids) {
              itens_disponiveis(id)
              .then((result) => {
                  // Using ES6's "template literals" to inject variables into the HTML.
                  const new_item = `
                      <div class="zombie">
                          <ul>
                              <li>Titulo: ${result.titulo}</li>
                              <li>Descrição: ${result.descricao}</li>
                              <li>Token: ${result.token}</li>
                          </ul>
                      </div>
                  `;

                  document.getElementById("itens").innerHTML = new_item;
              });
              }
          }

          function show_itens() {
              var table_tbody = document.getElementById("itens").getElementsByName('tbody')[0];
              var count_itens_disponiveis = leilao.methods.count_itens_disponiveis().call();

              table_tbody.empty();

              for (var i; i < count_itens_disponiveis; i++) {
                  itens_disponiveis(i)
                  .then((result) => {
                      // Using ES6's "template literals" to inject variables into the HTML.
                      const new_item = `
                          <div class="item">
                              <ul>
                                  <li>Titulo: ${result.titulo}</li>
                                  <li>Descrição: ${result.descricao}</li>
                                  <li>Token: ${result.token}</li>
                              </ul>
                          </div>
                      `;

                      table_tbody.innerHTML = new_item;
                  });
              }
          }

          function itens_disponiveis(id){
              return leilao.methods.itens_disponiveis(id).call();
          }

          function atualizarDados(){
              document.getElementById("contractAddress").innerHTML = "Your Account: " + userAccount;
          }

          function adicionar_item(){
              var titulo = document.getElementById("item_titulo").value;
              var descricao = document.getElementById("item_descricao").value;
              var valor_inicial = document.getElementById("item_valor_inicial").value;

              var valor_incremento = document.getElementById("item_valor_incremento").value;

              var data_expiracao = document.getElementById("item_data_expiracao").value;

              leilao.methods.adicionar_item(titulo, descricao, valor_inicial, valor_incremento, data_expiracao).send({ from: userAccount });
              return false;

          }




          // Padrão para detectar um web3 injetado.
          window.addEventListener('load', function () {
              web3Provider = null;
              // Modern dapp browsers...
              if (window.ethereum) {
                  web3Provider = window.ethereum;
                  try {
                      // Request account access
                      window.ethereum.enable();
                  } catch (error) {
                      // User denied account access...
                      console.error("User denied account access")
                  }
              }
              // Legacy dapp browsers...
              else if (window.web3) {
                  web3Provider = window.web3.currentProvider;
              }
              // If no injected web3 instance is detected, fall back to Ganache
              else {
                  console.log('No web3? You should consider trying MetaMask!')
                  web3Provider = new Web3.providers.HttpProvider('http://localhost:7545');
              }
              web3 = new Web3(web3Provider);
              startApp()
          })


      </script>
  </body>
</html>
